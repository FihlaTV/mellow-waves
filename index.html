<!doctype html>
<html>
  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">

    <style>
      * {
        margin: 0;
        padding: 0;
      }
      div.equalizer {
        position: absolute;
        top: 20px;
        right: 20px;
        border: 1px solid #ccc;
        background: white;
      }
      canvas {
        background: black;
        cursor: border;
      }
    </style>

  </head>
  <body>
    <div class="scripts">
      <script src="./third-party/three.js"></script>
      <script src="./third-party/two.js"></script>
      <script src="./third-party/sound.js"></script>
      <script src="./third-party/equalizer.js"></script>
      <script src="./src/sequencer.js"></script>
      <script>

        var TWO_PI = Math.PI * 2;

        var urls = [
          'M01_1.mp3', 'M02_1.mp3', 'M03_1.mp3', 'M04_1.mp3', 'M05_1.mp3',
          'M06_1.mp3', 'M07_1.mp3', 'M08_1.mp3', 'M09_1.mp3', 'M10_1.mp3',
          'M11_1.mp3', 'M12_1.mp3', 'M13_1.mp3', 'M14_1.mp3', 'M15_1.mp3',
          'M16_1.mp3', 'M17_1.mp3', 'M18_1.mp3', 'M19_1.mp3', 'M20_1.mp3',
          'M21_1.mp3', 'M22_1.mp3', 'M23_1.mp3', 'M24_1.mp3', 'M25_1.mp3',
          'M26_1.mp3'//, 'M27_1.mp3', 'M28_1.mp3', 'M29_1.mp3', 'M30_1.mp3'
        ];

        var freqs = {
          a: 1, b: 8, c: 0.5, d: 8, e: 8, f: 10, g: 1, h: 4, i: 2, j: 1.5, k: 2,
          l: 3, m: 8, n: 8, o: 2, p: 5, q: 5, r: 2, s: 6, t: 1.5, u: 10,
          v: 10, w: 10, x: 4, y: 8, z: 4
        };

        var keys = {
          a: 0, b: 1, c: 2, d: 3, e: 4, f: 5, g: 6, h: 7, i: 8, j: 9, k: 10,
          l: 11, m: 12, n: 13, o: 14, p: 15, q: 16, r: 17, s: 18, t: 19, u: 20,
          v: 21, w: 22, x: 23, y: 24, z: 25
        };

        var sounds = [];
        sounds.index = 0;
        sounds.ready = false;

        var equalizer, resolution = 11;
        Two.Resolution = 512;

        var two = new Two({
          type: Two.Types.canvas,
          fullscreen: true,
          autostart: true
        }).appendTo(document.body);

        var sequencer = new Sequencer(Sound.ctx);

        var ring = two.makeCircle(0, 0, Math.min(two.width, two.height) / 3);
        ring.stroke = 'white';
        ring.noFill();
        ring.visible = false;
        ring.curved = true;
        ring.phi = 2;
        ring.join = 'round';
        ring.direction = 1;
        ring.magnitude = 0.3;
        ring.velocity = 0;

        var buttons = [
          new Array(10),
          new Array(9),
          new Array(7)
        ];
        buttons.list = [];

        for (var i = 0; i < urls.length; i++) {

          var url = './assets/sounds/' + urls[i];
          var seed = Math.random();

          sounds.push(new Sound(url, loaded));

          sounds[i].phi = Math.floor(seed * 30) + 2;
          sounds[i].direction = Math.random() > 0.5 ? 1 : - 1;
          sounds[i].magnitude = Math.sin(seed * Math.PI + Math.PI / 2) * 0.5 + 0.1;
          sounds[i].velocity = Math.random() * Math.PI / 16 + Math.PI / 16;
          sounds[i].key = getKey(i);
          sounds[i].frequency = freqs[sounds[i].key];

        }

        for (var i = 0, id = 0; i < buttons.length; i++) {
          var row = buttons[i];
          for (var j = 0; j < row.length; j++) {
            buttons[i][j] = createButton(i, j, id);
            id++;
          }
        }

        function loaded() {
          sounds.index++;
          if (sounds.index >= sounds.length && !sounds.ready) {
            sounds.ready = true;
            setup();
          }
        }

        function setup() {

          equalizer = new Equalizer();//.appendTo(document.body);

          setupMouseEvents();
          setupTouchEvents();

          window.addEventListener('keydown', function(e) {
            var key = String.fromCharCode(e.which).toLowerCase();
            var sound = sounds[keys[key]];
            if (!sound) {
              return;
            }
            trigger(sound);
          }, false);

          window.addEventListener('keyup', function(e) {
            var key = String.fromCharCode(e.which).toLowerCase();
            var sound = sounds[keys[key]];
            if (!sound) {
              return;
            }
            sequencer.remove(sound);
          });

          window.addEventListener('resize', resize, false);
          resize();

          window.addEventListener('visibilitychange', function(e) {
            switch (document.visibilityState) {
              case 'visible':
                Sound.volume.gain.value = 1;
                break;
              case 'hidden':
                Sound.volume.gain.value = 0;
                break;
            }
          }, false);

          two.bind('update', update);
          sequencer.start();

        }

        function update() {

          equalizer.update(true);

          var length = ring.vertices.length;
          var radius = ring.radius;
          var phi = ring.phi;
          var fft = equalizer.average.value / 256;
          var magnitude = ring.magnitude;

          for (var i = 0; i < length; i++) {

            var pct = i / (length - 1);
            var sid = Math.floor(pct * resolution);

            var anchor = ring.vertices[i];
            var band = equalizer.bands[sid].value / 256;

            var theta = pct * TWO_PI;
            var phase = Math.sin(pct * TWO_PI * phi);
            var amp = radius * (1 + phase * magnitude * fft);
            var x = amp * Math.cos(theta);
            var y = amp * Math.sin(theta);

            anchor.x = x;
            anchor.y = y;

            var button = buttons.list[i];
            if (!button) {
              continue;
            }

            if (button.pressed) {
              opacity = 1;
            } else if (button.opacity > 0.001) {
              button.opacity -= button.opacity * 0.125;
            } else {
              button.opacity = 0;
            }

            if (button.fillOpacity > 0.001) {
              button.fillOpacity -= button.fillOpacity * 0.0625;
              button.fill = 'rgba(255, 255, 255, ' + button.fillOpacity + ')';
            } else if (button.fillOpacity > 0) {
              button.fillOpacity = 0;
              button.fill = 'rgba(255, 255, 255, ' + button.fillOpacity + ')';
            }

          }

          ring.rotation += ring.velocity * ring.direction;

        }

        function resize() {

          var aspect = two.width / two.height;

          ring._radius = Math.min(two.width, two.height) / 3;
          ring.linewidth = ring.radius / 100;
          ring.visible = true;

          two.scene.translation.set(two.width / 2, two.height / 2);

          var margin = two.width * 0.01;
          var width = two.width - margin;
          var height = two.height - margin;

          for (var i = 0; i < buttons.length; i++) {

            var xpct = 1 / buttons[i].length;
            var ypct = 1 / buttons.length;

            for (var j = 0; j < buttons[i].length; j++) {

              var button = buttons[i][j];
              var x = (j + 0.5) / buttons[i].length;
              var y = (i + 0.5) / buttons.length;

              x -= 0.5;
              x *= width;

              y -= 0.5;
              y *= height;

              button.translation.set(x, y);
              button.width = xpct * width - margin;
              button.height = ypct * height - margin;

            }
          }

        }

        function trigger(sound, callback) {
          // TODO: is there a way to have a callback to change
          // the fill of a button when the sound repeats? And then
          // make it fade relative to the sound.frequency?
          sequencer.add(sound, sound.frequency, callback);
          ring.phi = sound.phi;
          ring.direction = sound.direction;
          ring.magnitude = sound.magnitude;
          ring.velocity = sound.velocity;
        }

        function createButton(col, row, id) {

          var toKey = [
            'q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', 'a', 's', 'd',
            'f', 'g', 'h', 'j', 'k', 'l', 'z', 'x', 'c', 'v', 'b', 'n', 'm'
          ];
          var sound = sounds[keys[toKey[id]]];
          var button = two.makeRoundedRectangle(0, 0, 0, 0, 12);

          button.linewidth = 1;
          button.stroke = 'white';
          button.noFill();
          button.opacity = 0;
          button.sound = sound;
          buttons.list.push(button);

          return button;

        }

        function setupTouchEvents() {

          var cursors = {};

          var triggerButton = function(cursor, button) {

            cursor.button.pressed = true;
            button.opacity = 1;
            button.fillOpacity = 1;

            trigger(button.sound, function() {
              button.fillOpacity = 1;
            });
          };
          var touchstart = function(e) {

            var touches = e.touches;
            for (var i = 0; i < touches.length; i++) {

              var touch = touches[i];
              if (!(touch.identifier in cursors)) {
                cursors[touch.identifier] = new Two.Vector(
                  touch.clientX / two.width,
                  touch.clientY / two.height
                );
              } else {
                cursors[touch.identifier].set(
                  touch.clientX / two.width,
                  touch.clientY / two.height
                );
              }

              var cursor = cursors[touch.identifier];
              var row = Math.floor(buttons.length * cursor.y);

              if (row >= 0 && row < buttons.length) {
                var col = Math.floor(buttons[row].length * cursor.x);
                if (col >= 0 && col < buttons[row].length) {
                  var button = buttons[row][col];
                  cursor.button = button;
                  triggerButton(cursor, button);
                }
              }

            }

          };
          var touchmove = function(e) {

            var touches = e.touches;
            for (var i = 0; i < touches.length; i++) {

              var touch = touches[i];
              if (!(touch.identifier in cursors)) {
                cursors[touch.identifier] = new Two.Vector(
                  touch.clientX / two.width,
                  touch.clientY / two.height
                );
              } else {
                cursors[touch.identifier].set(
                  touch.clientX / two.width,
                  touch.clientY / two.height
                );
              }

              var cursor = cursors[touch.identifier];
              var row = Math.floor(buttons.length * cursor.y);
              if (row >= 0 && row < buttons.length) {
                var col = Math.floor(buttons[row].length * cursor.x);
                if (col >= 0 && col < buttons[row].length) {
                  var button = buttons[row][col];
                  if (button !== cursor.button) {
                    if (cursor.button) {
                      release(cursor);
                    }
                    cursor.button = button;
                    triggerButton(cursor, button);
                  }
                } else if (cursor.button) {
                  release(cursor);
                }
              } else if (cursor.button) {
                release(cursor);
              }

            }

          };
          var touchend = function(e) {
            for (var id in cursors) {
              var cursor = cursors[id];
              if (cursor.button) {
                release(cursor);
              }
            }
          };
          var release = function(cursor) {
            sequencer.remove(cursor.button.sound);
            cursor.button.pressed = false;
            delete cursor.button;
          };

          window.addEventListener('touchstart', touchstart, false);
          window.addEventListener('touchmove', touchmove, false);
          window.addEventListener('touchend', touchend, false);
          window.addEventListener('touchcancel', touchend, false);

        }

        function setupMouseEvents() {

          var mouse = new Two.Vector();

          var triggerButton = function(button) {

            mouse.button.pressed = true;

            button.opacity = 1;
            button.fillOpacity = 1;

            trigger(button.sound, function() {
              button.fillOpacity = 1;
            });

          };
          var mousedown = function(e) {

            mouse.set(e.clientX / two.width, e.clientY / two.height);

            window.addEventListener('mousemove', mousemove, false);
            window.addEventListener('mouseup', mouseup, false);

            var row = Math.floor(buttons.length * mouse.y);
            if (row >= 0 && row < buttons.length) {
              var col = Math.floor(buttons[row].length * mouse.x);
              if (col >= 0 && col < buttons[row].length) {
                var button = buttons[row][col];
                mouse.button = button;
                triggerButton(button);
              }
            }

          };
          var mousemove = function(e) {

            mouse.set(e.clientX / two.width, e.clientY / two.height);

            var row = Math.floor(buttons.length * mouse.y);
            if (row >= 0 && row < buttons.length) {
              var col = Math.floor(buttons[row].length * mouse.x);
              if (col >= 0 && col < buttons[row].length) {
                var button = buttons[row][col];
                if (button !== mouse.button) {
                  if (mouse.button) {
                    release();
                  }
                  mouse.button = button;
                  triggerButton(button);
                }
              } else if (mouse.button) {
                release();
              }
            } else if (mouse.button) {
              release();
            }

          };
          var mouseup = function(e) {
            if (mouse.button) {
              release();
            }
            window.removeEventListener('mousemove', mousemove, false);
            window.removeEventListener('mouseup', mouseup, false);
          };
          var release = function() {
            sequencer.remove(mouse.button.sound);
            mouse.button.pressed = false;
            delete mouse.button;
          };

          window.addEventListener('mousedown', mousedown, false);

        }

        function getKey(i) {
          for (var k in keys) {
            var key = keys[k];
            if (i === key) {
              return k;
            }
          }
          return null;
        }

      </script>
    </div>
  </body>
</html>
